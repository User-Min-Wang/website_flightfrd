{% extends "base.html" %}

{% block title %}ATC直播 - 航空爱好者社区{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="section-title">ATC直播</h2>
        <p class="lead">收听空中交通管制实时通信，体验飞行员与管制员的专业对话</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-broadcast-tower"></i> 实时ATC音频流</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="airport-selector" class="form-label">选择机场</label>
                        <select class="form-select" id="airport-selector">
                            <option value="">选择机场...</option>
                            <option value="PEK">北京首都国际机场 (PEK)</option>
                            <option value="PVG">上海浦东国际机场 (PVG)</option>
                            <option value="CAN">广州白云国际机场 (CAN)</option>
                            <option value="CTU">成都双流国际机场 (CTU)</option>
                            <option value="SHA">上海虹桥国际机场 (SHA)</option>
                            <option value="SZX">深圳宝安国际机场 (SZX)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="frequency-selector" class="form-label">频率选择</label>
                        <select class="form-select" id="frequency-selector">
                            <option value="">选择频率...</option>
                            <option value="tower">塔台 (TWR)</option>
                            <option value="ground">地面 (GND)</option>
                            <option value="approach">进近 (APP)</option>
                            <option value="departure">离场 (DEP)</option>
                            <option value="center">区域管制 (CTR)</option>
                        </select>
                    </div>
                </div>
                
                <div class="text-center my-4">
                    <div id="player-container" style="display:none;">
                        <audio controls id="atc-audio-player" style="width:100%;">
                            <source src="" type="audio/mpeg">
                            您的浏览器不支持音频播放。
                        </audio>
                    </div>
                    <div id="no-stream-message">
                        <i class="fas fa-microphone-slash fa-5x text-muted"></i>
                        <p class="mt-3">请选择机场和频率以开始收听ATC通信</p>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>提示：</strong>ATC通信可能因实际运营情况而有所不同，部分频道可能暂时无信号。
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-transcript"></i> 通信记录</h5>
            </div>
            <div class="card-body">
                <div class="list-group" id="transcript-list">
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">[15:32:45] PEK_TWR</h6>
                            <small class="text-muted">塔台</small>
                        </div>
                        <p class="mb-1">CCA1301, runway 36L, cleared for takeoff.</p>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">[15:32:50] CCA1301</h6>
                            <small class="text-muted">国航1301</small>
                        </div>
                        <p class="mb-1">CCA1301, runway 36L, cleared for takeoff, thank you.</p>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">[15:33:10] PEK_GND</h6>
                            <small class="text-muted">地面</small>
                        </div>
                        <p class="mb-1">CSN3745, taxi to holding point runway 36L via taxiway A, B, C.</p>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">[15:33:15] CSN3745</h6>
                            <small class="text-muted">南航3745</small>
                        </div>
                        <p class="mb-1">taxi to holding point runway 36L via taxiway A, B, C, CSN3745.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-satellite"></i> 热门ATC频道</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action" data-airport="PEK" data-frequency="tower">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">北京首都机场塔台</h6>
                            <span class="badge bg-primary">PEK_TWR</span>
                        </div>
                        <small>繁忙度: 高 | 收听人数: 1,248</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-airport="PVG" data-frequency="approach">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">上海浦东进近</h6>
                            <span class="badge bg-primary">PVG_APP</span>
                        </div>
                        <small>繁忙度: 中 | 收听人数: 892</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-airport="CAN" data-frequency="tower">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">广州白云机场塔台</h6>
                            <span class="badge bg-primary">CAN_TWR</span>
                        </div>
                        <small>繁忙度: 高 | 收听人数: 756</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-airport="CTU" data-frequency="ground">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">成都双流地面</h6>
                            <span class="badge bg-primary">CTU_GND</span>
                        </div>
                        <small>繁忙度: 中 | 收听人数: 534</small>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-chalkboard-teacher"></i> ATC术语学习</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="atc-terms-accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#term1">
                                Cleared for Takeoff
                            </button>
                        </h2>
                        <div id="term1" class="accordion-collapse collapse show" data-bs-parent="#atc-terms-accordion">
                            <div class="accordion-body">
                                允许起飞。飞行员收到此指令后可以开始起飞程序。
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#term2">
                                Hold Short
                            </button>
                        </h2>
                        <div id="term2" class="accordion-collapse collapse" data-bs-parent="#atc-terms-accordion">
                            <div class="accordion-body">
                                在指定位置等待，不得越过。通常用于等待进入跑道或穿越滑行道。
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#term3">
                                Squawk
                            </button>
                        </h2>
                        <div id="term3" class="accordion-collapse collapse" data-bs-parent="#atc-terms-accordion">
                            <div class="accordion-body">
                                设置应答机代码。ATC会告知飞行员设置特定的应答机编码。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> 最近收听</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    <li class="list-group-item">北京首都机场塔台</li>
                    <li class="list-group-item">上海浦东进近</li>
                    <li class="list-group-item">广州白云机场塔台</li>
                    <li class="list-group-item">成都双流地面</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 处理热门频道点击
    $('.list-group-item-action').on('click', function(e) {
        e.preventDefault();
        const airport = $(this).data('airport');
        const frequency = $(this).data('frequency');
        
        $('#airport-selector').val(airport);
        $('#frequency-selector').val(frequency);
        
        simulateStream(airport, frequency);
    });
    
    // 处理下拉选择变化
    $('#airport-selector, #frequency-selector').on('change', function() {
        const airport = $('#airport-selector').val();
        const frequency = $('#frequency-selector').val();
        
        if(airport && frequency) {
            simulateStream(airport, frequency);
        }
    });
    
    function simulateStream(airport, frequency) {
        // 显示播放器并隐藏消息
        $('#player-container').show();
        $('#no-stream-message').hide();
        
        // 这里在实际应用中会连接真实的ATC流
        // 暂时使用模拟音频
        $('#atc-audio-player source').attr('src', '');
        $('#atc-audio-player')[0].load();
        
        // 显示当前连接的信息
        $('.alert-info').html(`
            <i class="fas fa-circle text-success"></i> 
            <strong>正在收听:</strong> ${getAirportName(airport)} ${getFrequencyName(frequency)}
            <br><small>频道: ${airport}_${frequency.toUpperCase()}</small>
        `);
    }
    
    function getAirportName(code) {
        const airports = {
            'PEK': '北京首都国际机场',
            'PVG': '上海浦东国际机场',
            'CAN': '广州白云国际机场',
            'CTU': '成都双流国际机场',
            'SHA': '上海虹桥国际机场',
            'SZX': '深圳宝安国际机场'
        };
        return airports[code] || code;
    }
    
    function getFrequencyName(code) {
        const frequencies = {
            'tower': '塔台 (TWR)',
            'ground': '地面 (GND)',
            'approach': '进近 (APP)',
            'departure': '离场 (DEP)',
            'center': '区域管制 (CTR)'
        };
        return frequencies[code] || code;
    }
});
</script>
{% endblock %}