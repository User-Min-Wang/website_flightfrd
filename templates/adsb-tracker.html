{% extends "base.html" %}

{% block title %}ADS-B追踪 - 航空爱好者社区{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
    }
    .flight-info {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }
    .controls {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="section-title">ADS-B追踪系统</h2>
        <p class="lead">实时追踪全球航班动态，探索空中交通奥秘</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="controls">
            <div class="row">
                <div class="col-md-4">
                    <label for="aircraft-type" class="form-label">飞机类型</label>
                    <select class="form-select" id="aircraft-type">
                        <option value="all">全部类型</option>
                        <option value="A320">A320系列</option>
                        <option value="B737">B737系列</option>
                        <option value="A380">A380</option>
                        <option value="B787">B787</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="altitude-range" class="form-label">高度范围</label>
                    <select class="form-select" id="altitude-range">
                        <option value="all">全部高度</option>
                        <option value="low">低空(0-10000英尺)</option>
                        <option value="medium">中空(10000-30000英尺)</option>
                        <option value="high">高空(30000英尺以上)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="distance" class="form-label">距离范围</label>
                    <select class="form-select" id="distance">
                        <option value="50">50公里</option>
                        <option value="100" selected>100公里</option>
                        <option value="200">200公里</option>
                        <option value="500">500公里</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>
    
    <div class="col-md-4">
        <div class="flight-info">
            <h5><i class="fas fa-info-circle"></i> 飞行信息</h5>
            <div id="flight-details">
                <p class="text-muted">请选择一个航班以查看详细信息</p>
            </div>
        </div>
        
        <div class="mt-4">
            <h5><i class="fas fa-list"></i> 最近航班</h5>
            <div class="list-group" id="flight-list">
                <!-- 航班列表将通过JavaScript动态填充 -->
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">CA1234</h6>
                        <small>10分钟前</small>
                    </div>
                    <p class="mb-1">北京 → 上海</p>
                    <small class="text-muted">A330 | 高度: 35,000英尺 | 速度: 850 km/h</small>
                </div>
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">MU5127</h6>
                        <small>15分钟前</small>
                    </div>
                    <p class="mb-1">上海 → 广州</p>
                    <small class="text-muted">B737 | 高度: 28,000英尺 | 速度: 820 km/h</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 模拟数据展示区域 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> 实时数据统计</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <h3 class="text-primary">1,248</h3>
                        <p>当前追踪航班</p>
                    </div>
                    <div class="col-md-3 mb-3">
                        <h3 class="text-success">342</h3>
                        <p>起飞中</p>
                    </div>
                    <div class="col-md-3 mb-3">
                        <h3 class="text-info">298</h3>
                        <p>飞行中</p>
                    </div>
                    <div class="col-md-3 mb-3">
                        <h3 class="text-warning">156</h3>
                        <p>降落中</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
// 初始化地图
var map = L.map('map').setView([39.9042, 116.4074], 6); // 以北京为中心

// 添加OpenStreetMap瓦片图层
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// 模拟飞机图标
var planeIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/3329/3329894.png',
    iconSize: [32, 32],
    iconAnchor: [16, 16],
    popupAnchor: [0, -16]
});

// 模拟航班数据
var flights = [
    {id: 'CA1234', callsign: 'CA1234', lat: 39.9042, lng: 116.4074, altitude: 35000, speed: 850, from: '北京', to: '上海', aircraft: 'A330'},
    {id: 'MU5127', callsign: 'MU5127', lat: 31.2304, lng: 121.4737, altitude: 28000, speed: 820, from: '上海', to: '广州', aircraft: 'B737'},
    {id: 'CZ3521', callsign: 'CZ3521', lat: 23.1291, lng: 113.2644, altitude: 32000, speed: 800, from: '广州', to: '成都', aircraft: 'A320'},
    {id: 'HU7608', callsign: 'HU7608', lat: 30.5728, lng: 104.0668, altitude: 29000, speed: 780, from: '成都', to: '西安', aircraft: 'B737'},
    {id: 'FM9101', callsign: 'FM9101', lat: 34.3416, lng: 108.9398, altitude: 31000, speed: 810, from: '西安', to: '深圳', aircraft: 'A321'}
];

// 在地图上添加飞机标记
flights.forEach(function(flight) {
    var marker = L.marker([flight.lat, flight.lng], {icon: planeIcon})
        .addTo(map)
        .bindPopup(`<b>${flight.callsign}</b><br>
                   机型: ${flight.aircraft}<br>
                   航线: ${flight.from} → ${flight.to}<br>
                   高度: ${flight.altitude} 英尺<br>
                   速度: ${flight.speed} km/h`);
    
    // 点击飞机标记时显示详细信息
    marker.on('click', function() {
        showFlightDetails(flight);
    });
});

// 显示航班详细信息
function showFlightDetails(flight) {
    document.getElementById('flight-details').innerHTML = `
        <h6>${flight.callsign}</h6>
        <p><strong>航线:</strong> ${flight.from} → ${flight.to}</p>
        <p><strong>机型:</strong> ${flight.aircraft}</p>
        <p><strong>高度:</strong> ${flight.altitude.toLocaleString()} 英尺</p>
        <p><strong>速度:</strong> ${flight.speed} km/h</p>
        <p><strong>状态:</strong> <span class="badge bg-primary">飞行中</span></p>
    `;
}

// 模拟实时更新
setInterval(function() {
    // 更新飞机位置（模拟飞行）
    flights.forEach(function(flight, index) {
        // 简单的位置更新模拟
        var newLat = flight.lat + (Math.random() - 0.5) * 0.01;
        var newLng = flight.lng + (Math.random() - 0.5) * 0.01;
        
        // 更新标记位置
        var marker = map._layers[Object.keys(map._layers)[index + 2]]; // 跳过tile layer和对象层
        if(marker && marker.setLatLng) {
            marker.setLatLng([newLat, newLng]);
        }
    });
}, 5000);
</script>
{% endblock %}